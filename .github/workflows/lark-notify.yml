name: Deploy and Notify Lark

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  LARK_WEBHOOK: "https://open.larksuite.com/open-apis/bot/v2/hook/88fccfea-8fad-47d9-99a9-44d214785fff"

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get commit info
      id: commit_info
      run: |
        echo "commit_message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
        echo "author_name=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
        echo "repo_url=${{ github.event.repository.html_url }}" >> $GITHUB_OUTPUT

    - name: Send notification to Lark
      run: |
        curl -X POST "$LARK_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "ðŸš€ Frontend Deployment"
                },
                "template": "blue"
              },
              "elements": [
                {
                  "tag": "img",
                  "img_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "mode": "fit_horizontal"
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "**Deployer:** ${{ steps.commit_info.outputs.author_name }}"
                  }
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "**Commit:** ${{ steps.commit_info.outputs.commit_message }}"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "content": "ðŸ”— View Repo",
                        "tag": "plain_text"
                      },
                      "url": "${{ steps.commit_info.outputs.repo_url }}",
                      "type": "primary"
                    }
                  ]
                }
              ]
            }
          }'

    - name: Deploy application
      run: |
        echo "ðŸš€ Deploying frontend application..."
        # npm run build
        # aws s3 sync dist/ s3://your-bucket/
        echo "âœ… Frontend deployment completed!"
