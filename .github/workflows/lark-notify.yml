name: Backend Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload card image
        id: upload_image
        run: |
          curl -X POST "https://open.larkoffice.com/open-apis/im/v1/images" \
            -H "Authorization: Bearer ${{ secrets.LARK_BOT_TOKEN }}" \
            -F "image=@./assets/backend-banner.png" \
            | jq -r '.data.image_key' > image_key.txt
        env:
          LARK_BOT_TOKEN: ${{ secrets.LARK_BOT_TOKEN }}

      - name: Read image key
        id: read_image_key
        run: echo "image_key=$(cat image_key.txt)" >> $GITHUB_ENV

      - name: Send notification to Lark
        run: |
          curl -X POST ${{ secrets.LARK_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "ðŸš€ Backend Deployment"
                  },
                  "template": "green"
                },
                "elements": [
                  {
                    "tag": "img",
                    "img_key": "'${{ env.image_key }}'",
                    "mode": "fit_horizontal",
                    "preview": true
                  },
                  {
                    "tag": "column_set",
                    "columns": [
                      {
                        "tag": "column",
                        "width": "weighted",
                        "weight": 1,
                        "elements": [
                          {
                            "tag": "div",
                            "text": {
                              "tag": "lark_md",
                              "content": "**ENV**\nProduction"
                            }
                          }
                        ]
                      },
                      {
                        "tag": "column",
                        "width": "weighted",
                        "weight": 1,
                        "elements": [
                          {
                            "tag": "div",
                            "text": {
                              "tag": "lark_md",
                              "content": "**Deployer**\n${{ github.actor }}"
                            }
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**Service Name**\n${{ github.repository }}"
                    }
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**Commit Messages ðŸ‘€**\nâ€¢ ${{ github.event.head_commit.message }}"
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "content": "View repo",
                          "tag": "plain_text"
                        },
                        "url": "https://github.com/${{ github.repository }}",
                        "type": "primary"
                      }
                    ]
                  }
                ]
              }
            }'
