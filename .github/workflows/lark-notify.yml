name: Lark Notification

on:
  push:
    branches:
      - main

jobs:
  notify-lark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Verify secrets
        run: |
          if [ -z "${{ secrets.LARK_WEBHOOK }}" ]; then
            echo "Error: LARK_WEBHOOK secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.LARK_APP_ID }}" ] || [ -z "${{ secrets.LARK_APP_SECRET }}" ]; then
            echo "Error: LARK_APP_ID or LARK_APP_SECRET is not set"
            exit 1
          fi

      - name: Get Tenant Access Token
        id: get-token
        run: |
          response=$(curl -s -X POST "https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal" \
            -H "Content-Type: application/json" \
            -d "{\"app_id\": \"${{ secrets.LARK_APP_ID }}\", \"app_secret\": \"${{ secrets.LARK_APP_SECRET }}\"}")
          echo "Token response: $response"
          token=$(echo $response | jq -r '.tenant_access_token // empty')
          if [ -z "$token" ]; then
            echo "Error: Failed to obtain tenant access token"
            exit 1
          fi
          echo "TOKEN=$token" >> $GITHUB_ENV
        env:
          LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
          LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}

      - name: Verify image exists
        run: |
          if [ ! -f "github_logo.png" ]; then
            echo "Error: github_logo.png not found in repository"
            exit 1
          fi

      - name: Upload Image to Lark
        id: upload-image
        run: |
          response=$(curl -s -X POST "https://open.larksuite.com/open-apis/im/v1/images" \
            -H "Authorization: Bearer ${{ env.TOKEN }}" \
            -F "image_type=message" \
            -F "image=@github_logo.png")
          echo "Image upload response: $response"
          image_key=$(echo $response | jq -r '.data.image_key // empty')
          if [ -z "$image_key" ]; then
            echo "Error: Failed to upload image to Lark"
            exit 1
          fi
          echo "IMAGE_KEY=$image_key" >> $GITHUB_ENV

      - name: Send Lark Notification
        run: |
          curl -s -X POST "${{ secrets.LARK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "Backend Deployment"
                  },
                  "template": "blue"
                },
                "elements": [
                  {
                    "tag": "img",
                    "img_key": "${{ env.IMAGE_KEY }}",
                    "mode": "fit_horizontal",
                    "preview": true
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**ü§ñ Deployer**\n${{ github.actor }}"
                    }
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**Service Name**\n${{ github.repository }}"
                    }
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**Commit Message**\n‚Ä¢ ${{ github.event.commits[0].message }}"
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "content": "‡∏î‡∏π Repository üîç",
                          "tag": "plain_text"
                        },
                        "url": "${{ github.event.repository.html_url }}",
                        "type": "primary"
                      }
                    ]
                  }
                ]
              }
            }' || { echo "Error: Failed to send Lark notification"; exit 1; }
        env:
          LARK_WEBHOOK: ${{ secrets.LARK_WEBHOOK }}
